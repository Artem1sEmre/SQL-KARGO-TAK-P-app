create database kargo;
use kargo;

create table musteri(
    musteri_id int,
    ad nchar,
    soyad nchar,
    adres nchar,
    tel nchar
);

create table sube(
    sube_id int,
    sube_adi nchar,
    il nchar
);

create table kurye(
    kurye_id int,
    ad nchar,
    soyad nchar,
    tel nchar,
    sube_id int
);

create table kargo(
    kargo_id int,
    musteri_id int,
    sube_id int,
    agirlik int,
    ucret int,
    durum nchar,
    tarih datetime
);

create table teslimat(
    teslimat_id int,
    kargo_id int,
    kurye_id int,
    teslim_durumu nchar
);

insert into musteri values (1,'Emre','Duyar','İstanbul','5551');
insert into musteri values (2,'Ali','Kaya','Ankara','5552');

insert into sube values (1,'Merkez','İstanbul');
insert into sube values (2,'Ankara','Ankara');

insert into kurye values (1,'Ahmet','Polat','5001',1);
insert into kurye values (2,'Mehmet','Ak','5002',2);



create trigger trg_kargo_goster
after insert on kargo
begin
    select * from kargo;
end;

create trigger trg_kargo_ucret
after insert on kargo
begin
    update kargo
    set ucret = agirlik * 20;
end;

create trigger trg_kargo_durum
after insert on kargo
begin
    update kargo
    set durum = 'Hazırlanıyor';
end;

create trigger trg_teslimat_durum
after insert on teslimat
begin
    update kargo
    set durum = 'Dağıtımda';
end;

create trigger trg_kargo_silme
before delete on kargo
begin
    signal sqlstate '45000'
    set message_text = 'Kargo silinemez';
end;

create trigger trg_kargo_update
after update on kargo
begin
    select * from kargo;
end;

create trigger trg_teslimat_update
after update on teslimat
begin
    select * from teslimat;
end;

create trigger trg_musteri_goster
after insert on musteri
begin
    select * from musteri;
end;

create trigger trg_kurye_goster
after insert on kurye
begin
    select * from kurye;
end;

create trigger trg_sube_goster
after insert on sube
begin
    select * from sube;
end;

create procedure sp_musteri_ekle(
    p_id int,
    p_ad nchar,
    p_soyad nchar,
    p_adres nchar,
    p_tel nchar
)
begin
    insert into musteri values (p_id,p_ad,p_soyad,p_adres,p_tel);
end;

create procedure sp_kargo_ekle(
    p_kargo int,
    p_musteri int,
    p_sube int,
    p_agirlik int
)
begin
    insert into kargo values (p_kargo,p_musteri,p_sube,p_agirlik,0,'');
end;

create procedure sp_musteri_kargo(p_musteri int)
begin
    select * from kargo where musteri_id = p_musteri;
end;

create procedure sp_en_cok_kargo()
begin
    select musteri_id, count(*) as toplam
    from kargo
    group by musteri_id
    order by toplam desc;
end;

create procedure sp_toplam_gelir()
begin
    select sum(ucret) as toplam from kargo;
end;

create procedure sp_sube_kargo()
begin
    select sube_id, count(*) as toplam
    from kargo
    group by sube_id;
end;

create procedure sp_kurye_teslim(p_kurye int)
begin
    select * from teslimat where kurye_id = p_kurye;
end;

create procedure sp_gunluk_kargo()
begin
    select * from kargo where date(tarih)=curdate();
end;

create procedure sp_teslim_edilen()
begin
    select * from kargo where durum='Teslim Edildi';
end;

create procedure sp_musteri_detay(p_musteri int)
begin
    select musteri.ad, musteri.soyad, kargo.ucret
    from musteri
    inner join kargo
    on musteri.musteri_id = kargo.musteri_id
    where musteri.musteri_id = p_musteri;
end;

